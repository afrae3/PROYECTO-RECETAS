<div class="dashboard-container">
  <h1>üìä Dashboard Nutricional</h1>

  <div class="objetivos-control" *ngIf="!loading && estadisticas">
    <div class="objetivos-header">
      <label class="checkbox-label">
        <input type="checkbox" 
               [checked]="tieneObjetivos" 
               (change)="toggleFormularioObjetivos()"
               [disabled]="tieneObjetivos">
        <span>Configurar objetivos nutricionales personalizados</span>
      </label>
      <button *ngIf="tieneObjetivos" 
              (click)="eliminarObjetivos()" 
              class="btn-eliminar-objetivos">
        üóëÔ∏è Eliminar Objetivos
      </button>
    </div>

    <div *ngIf="mostrarFormularioObjetivos && !tieneObjetivos" class="formulario-objetivos">
      <h3>üìù Cu√©ntanos sobre ti</h3>
      <p class="subtitle">Calcularemos tus objetivos nutricionales personalizados basados en tu perfil</p>
      
      <div class="objetivos-grid-personal">
        <div class="objetivo-item">
          <label>Sexo</label>
          <select [(ngModel)]="datosPersonales.sexo">
            <option value="masculino">üë® Masculino</option>
            <option value="femenino">üë© Femenino</option>
          </select>
        </div>

        <div class="objetivo-item">
          <label>Edad (a√±os)</label>
          <input type="number" [(ngModel)]="datosPersonales.edad" min="15" max="100">
        </div>

        <div class="objetivo-item">
          <label>Peso (kg)</label>
          <input type="number" [(ngModel)]="datosPersonales.peso" min="30" max="200" step="0.1">
        </div>

        <div class="objetivo-item">
          <label>Altura (cm)</label>
          <input type="number" [(ngModel)]="datosPersonales.altura" min="120" max="250">
        </div>

        <div class="objetivo-item objetivo-item-full">
          <label>Nivel de actividad f√≠sica</label>
          <select [(ngModel)]="datosPersonales.nivelActividad">
            <option value="sedentario">üõãÔ∏è Sedentario (poco o ning√∫n ejercicio)</option>
            <option value="ligero">üö∂ Ligero (ejercicio 1-3 d√≠as/semana)</option>
            <option value="moderado">üèÉ Moderado (ejercicio 3-5 d√≠as/semana)</option>
            <option value="activo">üí™ Activo (ejercicio 6-7 d√≠as/semana)</option>
            <option value="muy_activo">üî• Muy activo (ejercicio intenso diario)</option>
          </select>
        </div>

        <div class="objetivo-item objetivo-item-full">
          <label>Tu objetivo</label>
          <select [(ngModel)]="datosPersonales.objetivo">
            <option value="perder_peso">üìâ Perder peso (d√©ficit cal√≥rico)</option>
            <option value="mantener">‚öñÔ∏è Mantener peso actual</option>
            <option value="ganar_musculo">üìà Ganar m√∫sculo (super√°vit cal√≥rico)</option>
          </select>
        </div>
      </div>

      <div class="info-calculo">
        <p><strong>‚ÑπÔ∏è Informaci√≥n:</strong></p>
        <ul>
          <li>Usamos la f√≥rmula de Mifflin-St Jeor para calcular tu metabolismo basal</li>
          <li>Los macronutrientes se ajustan seg√∫n tu objetivo</li>
          <li>Prote√≠nas: 2g por kg de peso corporal</li>
          <li>Grasas: 27% de las calor√≠as totales</li>
          <li>Carbohidratos: resto de calor√≠as disponibles</li>
        </ul>
      </div>

      <div class="objetivos-botones">
        <button (click)="calcularYGuardarObjetivos()" class="btn-guardar">
          üßÆ Calcular y Guardar Objetivos
        </button>
        <button (click)="toggleFormularioObjetivos()" class="btn-cancelar">
          Cancelar
        </button>
      </div>
    </div>

    <div *ngIf="tieneObjetivos" class="datos-personales-guardados">
      <h4>üë§ Tu perfil actual</h4>
      <div class="perfil-grid">
        <span><strong>Sexo:</strong> {{ getNombreSexo(datosPersonales.sexo) }}</span>
        <span><strong>Edad:</strong> {{ datosPersonales.edad }} a√±os</span>
        <span><strong>Peso:</strong> {{ datosPersonales.peso }} kg</span>
        <span><strong>Altura:</strong> {{ datosPersonales.altura }} cm</span>
        <span class="perfil-full"><strong>Actividad:</strong> {{ getNombreActividad(datosPersonales.nivelActividad) }}</span>
        <span class="perfil-full"><strong>Objetivo:</strong> {{ getNombreObjetivo(datosPersonales.objetivo) }}</span>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Cargando estad√≠sticas...</p>
  </div>

  <div *ngIf="error" class="error-card">
    <span class="error-icon">‚ö†Ô∏è</span>
    <p>{{ error }}</p>
  </div>

  <div *ngIf="estadisticas && estadisticas.totalesSemanales && !loading" class="dashboard-content">
    
    <div class="summary-section">
      <h2>Resumen Semanal</h2>
      <p class="fecha-menu">Men√∫ generado: {{ estadisticas.fechaMenu }}</p>
      
      <div class="cards-grid">
        <div class="stat-card calorias">
          <div class="stat-icon">üî•</div>
          <div class="stat-content">
            <h3>Calor√≠as Totales</h3>
            <p class="stat-value">{{ estadisticas.totalesSemanales.calorias | number }}</p>
            <p class="stat-sub" *ngIf="!estadisticas.objetivos">
              Promedio: {{ estadisticas.promediosDiarios.calorias | number }} kcal/d√≠a
            </p>
            <p class="stat-sub" *ngIf="estadisticas.objetivos">
              <span [class.objetivo-alcanzado]="calcularPorcentajeObjetivo('calorias') >= 90 && calcularPorcentajeObjetivo('calorias') <= 110"
                    [class.objetivo-bajo]="calcularPorcentajeObjetivo('calorias') < 90"
                    [class.objetivo-alto]="calcularPorcentajeObjetivo('calorias') > 110">
                {{ calcularPorcentajeObjetivo('calorias') }}%
              </span>
              del objetivo ({{ estadisticas.objetivos.calorias }} kcal/d√≠a)
            </p>
          </div>
        </div>

        <div class="stat-card proteinas">
          <div class="stat-icon">üí™</div>
          <div class="stat-content">
            <h3>Prote√≠nas</h3>
            <p class="stat-value">{{ estadisticas.totalesSemanales.proteinas | number:'1.0-1' }} g</p>
            <p class="stat-sub" *ngIf="!estadisticas.objetivos">
              Promedio: {{ estadisticas.promediosDiarios.proteinas | number:'1.0-1' }} g/d√≠a
            </p>
            <p class="stat-sub" *ngIf="estadisticas.objetivos">
              <span [class.objetivo-alcanzado]="calcularPorcentajeObjetivo('proteinas') >= 90"
                    [class.objetivo-bajo]="calcularPorcentajeObjetivo('proteinas') < 90">
                {{ calcularPorcentajeObjetivo('proteinas') }}%
              </span>
              del objetivo ({{ estadisticas.objetivos.proteinas }} g/d√≠a)
            </p>
          </div>
        </div>

        <div class="stat-card carbohidratos">
          <div class="stat-icon">üçû</div>
          <div class="stat-content">
            <h3>Carbohidratos</h3>
            <p class="stat-value">{{ estadisticas.totalesSemanales.carbohidratos | number:'1.0-1' }} g</p>
            <p class="stat-sub" *ngIf="!estadisticas.objetivos">
              Promedio: {{ estadisticas.promediosDiarios.carbohidratos | number:'1.0-1' }} g/d√≠a
            </p>
            <p class="stat-sub" *ngIf="estadisticas.objetivos">
              <span [class.objetivo-alcanzado]="calcularPorcentajeObjetivo('carbohidratos') >= 90 && calcularPorcentajeObjetivo('carbohidratos') <= 110"
                    [class.objetivo-bajo]="calcularPorcentajeObjetivo('carbohidratos') < 90"
                    [class.objetivo-alto]="calcularPorcentajeObjetivo('carbohidratos') > 110">
                {{ calcularPorcentajeObjetivo('carbohidratos') }}%
              </span>
              del objetivo ({{ estadisticas.objetivos.carbohidratos }} g/d√≠a)
            </p>
          </div>
        </div>

        <div class="stat-card grasas">
          <div class="stat-icon">ü•ë</div>
          <div class="stat-content">
            <h3>Grasas</h3>
            <p class="stat-value">{{ estadisticas.totalesSemanales.grasas | number:'1.0-1' }} g</p>
            <p class="stat-sub" *ngIf="!estadisticas.objetivos">
              Promedio: {{ estadisticas.promediosDiarios.grasas | number:'1.0-1' }} g/d√≠a
            </p>
            <p class="stat-sub" *ngIf="estadisticas.objetivos">
              <span [class.objetivo-alcanzado]="calcularPorcentajeObjetivo('grasas') >= 90 && calcularPorcentajeObjetivo('grasas') <= 110"
                    [class.objetivo-bajo]="calcularPorcentajeObjetivo('grasas') < 90"
                    [class.objetivo-alto]="calcularPorcentajeObjetivo('grasas') > 110">
                {{ calcularPorcentajeObjetivo('grasas') }}%
              </span>
              del objetivo ({{ estadisticas.objetivos.grasas }} g/d√≠a)
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="daily-section">
      <h2>Desglose Diario</h2>
      
      <div class="dias-container">
        <div *ngFor="let dia of diasConDatos" class="dia-card">
          <h3>{{ dia }}</h3>
          
          <div class="nutrientes-dia" *ngIf="estadisticas.datosPorDia[dia]">
            <div class="nutriente-item">
              <span class="label">Calor√≠as:</span>
              <span class="value">{{ estadisticas.datosPorDia[dia].calorias | number }} kcal</span>
            </div>
            <div class="nutriente-item">
              <span class="label">Prote√≠nas:</span>
              <span class="value">{{ estadisticas.datosPorDia[dia].proteinas | number:'1.0-1' }}g</span>
            </div>
            <div class="nutriente-item">
              <span class="label">Grasas:</span>
              <span class="value">{{ estadisticas.datosPorDia[dia].grasas | number:'1.0-1' }}g</span>
            </div>
            <div class="nutriente-item">
              <span class="label">Carbohidratos:</span>
              <span class="value">{{ estadisticas.datosPorDia[dia].carbohidratos | number:'1.0-1' }}g</span>
            </div>
          </div>

          <div class="comidas-list" *ngIf="estadisticas.datosPorDia[dia] && estadisticas.datosPorDia[dia].comidas">
            <h4>Comidas del d√≠a:</h4>
            <div *ngFor="let comida of obtenerComidasOrdenadas(dia)" 
                 class="comida-item" 
                 [ngClass]="comida.tipo">
              <strong>{{ comida.tipo | titlecase }}:</strong> {{ comida.nombre }}
              <span class="comida-calorias">({{ comida.calorias | number }} kcal)</span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>